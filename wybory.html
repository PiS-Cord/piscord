<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Wybory</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="arkusze.js"></script>

<style>
body { font-family: Arial; text-align:center; }

input, select {
  padding:8px;
  margin:5px;
}

.candidate {
  padding:10px;
  margin:5px;
  border-radius:6px;
  color:white;
  cursor:pointer;
  display:inline-block;
}

.map path {
  stroke:#fff;
  stroke-width:1;
  cursor:pointer;
}

</style>
</head>
<body>

<h1>Wybory</h1>

<div>
  <input id="nick" placeholder="Nick Discord">
  <input id="discordId" placeholder="Discord ID">
  <select id="wojewodztwo">
    <option>Mazowieckie</option>
    <option>Śląskie</option>
    <option>Małopolskie</option>
  </select>
</div>

<h3>Wybierz kandydata</h3>
<div id="candidates"></div>

<h3>Wyniki</h3>
<canvas id="chart" width="400" height="200"></canvas>

<script>

// =======================
// KONFIG KANDYDATÓW
// =======================

const candidates = {
  A: { name: "Kandydat A", color: "#e63946" },
  B: { name: "Kandydat B", color: "#1d3557" },
  C: { name: "Kandydat C", color: "#2a9d8f" }
};

// =======================
// GENEROWANIE PRZYCISKÓW
// =======================

const container = document.getElementById("candidates");

for (const key in candidates) {
  const div = document.createElement("div");
  div.className = "candidate";
  div.textContent = candidates[key].name;
  div.style.backgroundColor = candidates[key].color;
  div.onclick = () => vote(key);
  container.appendChild(div);
}

// =======================
// ODDANIE GŁOSU
// =======================

async function vote(candidate){

  const nick = document.getElementById("nick").value.trim();
  const discordId = document.getElementById("discordId").value.trim();
  const woj = document.getElementById("wojewodztwo").value;

  if(!nick || !discordId){
    alert("Podaj nick i Discord ID");
    return;
  }

  const data = await Arkusze.getAll("Arkusz1");
  const nextRow = data.length + 1; // wiersz 1 pusty

  const voteId = "V" + Date.now();
  const timestamp = new Date().toISOString();

  await Arkusze.appendRow("Arkusz1", [
    "",               // kolumna A pusta
    voteId,           // B
    nick,             // C
    discordId,        // D
    woj,              // E
    candidate,        // F
    timestamp         // G
  ]);

  await generateStats();
  alert("Głos zapisany.");
}

// =======================
// GENEROWANIE FORMUŁ W KOLUMNIE W
// =======================

async function generateStats(){

  let row = 2;

  for(const key in candidates){

    await Arkusze.setValue("Arkusz1", row, "W", candidates[key].name);
    await Arkusze.applyFormula("Arkusz1", row, "X", "COUNTIF", "F:F,\""+key+"\"");
    row++;
  }

  loadChart();
}

// =======================
// WYKRES
// =======================

let chart;

async function loadChart(){

  const data = await Arkusze.getAll("Arkusz1");

  let totals = {};
  for(const key in candidates) totals[key]=0;

  for(let i=1;i<data.length;i++){
    const candidate = data[i][5];
    if(totals[candidate] !== undefined)
      totals[candidate]++;
  }

  const ctx = document.getElementById("chart").getContext("2d");
  if(chart) chart.destroy();

  chart = new Chart(ctx,{
    type:"bar",
    data:{
      labels:Object.keys(candidates).map(k=>candidates[k].name),
      datasets:[{
        label:"Liczba głosów",
        data:Object.keys(candidates).map(k=>totals[k]),
        backgroundColor:Object.keys(candidates).map(k=>candidates[k].color)
      }]
    }
  });
}

loadChart();
setInterval(loadChart,5000);

</script>

</body>
</html>
